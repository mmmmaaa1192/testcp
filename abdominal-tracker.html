<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è…¹ç­‹ãƒãƒ“ãƒƒãƒˆãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .calendar-day {
            aspect-ratio: 1;
            transition: all 0.3s ease;
        }
        .calendar-day:hover {
            transform: scale(1.05);
        }
        .completed {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }
        .streak-badge {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            box-shadow: 0 4px 15px rgba(255, 167, 38, 0.4);
        }
        .stat-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glass-card {
            backdrop-filter: blur(16px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(209, 213, 219, 0.3);
        }
        .emoji-rotate {
            display: inline-block;
            animation: rotate 3s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
        }
        .tab-btn.active {
            background: white;
            color: #7c3aed;
            border-color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .tab-btn.active:hover {
            background: white;
        }
        .quick-input-btn {
            transition: all 0.2s ease;
        }
        .quick-input-btn:active {
            transform: scale(0.95);
        }
        #visual-tab {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .capture-area {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 fade-in">
            <div class="inline-block mb-4">
                <span class="text-6xl emoji-rotate">ğŸ’ª</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 drop-shadow-lg">
                è…¹ç­‹ãƒãƒ“ãƒƒãƒˆãƒˆãƒ©ãƒƒã‚«ãƒ¼
            </h1>
            <p class="text-white/80 text-lg">æ¯æ—¥ã®è…¹ç­‹ã‚’è¨˜éŒ²ã—ã¦ã€å¥åº·çš„ãªç¿’æ…£ã‚’ä½œã‚ã†ï¼</p>
            
            <!-- Tab Navigation -->
            <div class="flex justify-center gap-4 mt-6">
                <button id="tab-tracker" class="tab-btn active px-6 py-3 rounded-xl font-bold transition-all">
                    ğŸ“Š ãƒˆãƒ©ãƒƒã‚«ãƒ¼
                </button>
                <button id="tab-visual" class="tab-btn px-6 py-3 rounded-xl font-bold transition-all">
                    ğŸ¨ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é€²æ—
                </button>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 fade-in">
            <!-- Streak -->
            <div class="glass-card rounded-2xl p-6 text-center shadow-xl">
                <div class="text-4xl mb-2">ğŸ”¥</div>
                <div class="text-3xl font-bold text-orange-500" id="streak-count">0</div>
                <div class="text-sm text-gray-600 font-medium">é€£ç¶šæ—¥æ•°</div>
            </div>
            
            <!-- Total Days -->
            <div class="glass-card rounded-2xl p-6 text-center shadow-xl">
                <div class="text-4xl mb-2">ğŸ“…</div>
                <div class="text-3xl font-bold text-blue-500" id="total-days">0</div>
                <div class="text-sm text-gray-600 font-medium">ç´¯è¨ˆå®Ÿæ–½æ—¥</div>
            </div>
            
            <!-- Total Reps -->
            <div class="glass-card rounded-2xl p-6 text-center shadow-xl">
                <div class="text-4xl mb-2">ğŸ’¯</div>
                <div class="text-3xl font-bold text-purple-500" id="total-reps">0</div>
                <div class="text-sm text-gray-600 font-medium">ç´¯è¨ˆå›æ•°</div>
            </div>
            
            <!-- Average -->
            <div class="glass-card rounded-2xl p-6 text-center shadow-xl">
                <div class="text-4xl mb-2">â­</div>
                <div class="text-3xl font-bold text-green-500" id="average-reps">0</div>
                <div class="text-sm text-gray-600 font-medium">å¹³å‡å›æ•°</div>
            </div>
        </div>

        <!-- Tracker Tab -->
        <div id="tracker-tab" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Input & Goal -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Input Card -->
                <div class="glass-card rounded-2xl p-6 shadow-xl fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>ğŸ“</span> ä»Šæ—¥ã®è¨˜éŒ²
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥ä»˜</label>
                            <input 
                                type="date" 
                                id="record-date" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                è…¹ç­‹å›æ•°
                            </label>
                            <input 
                                type="number" 
                                id="reps-input" 
                                placeholder="ä¾‹: 30"
                                min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition text-2xl font-bold text-center"
                            >
                            
                            <!-- Quick Input Buttons -->
                            <div class="grid grid-cols-4 gap-2 mt-3">
                                <button onclick="addReps(5)" class="quick-input-btn bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-2 rounded-lg">
                                    +5
                                </button>
                                <button onclick="addReps(10)" class="quick-input-btn bg-green-100 hover:bg-green-200 text-green-700 font-bold py-2 rounded-lg">
                                    +10
                                </button>
                                <button onclick="addReps(20)" class="quick-input-btn bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-2 rounded-lg">
                                    +20
                                </button>
                                <button onclick="addReps(50)" class="quick-input-btn bg-pink-100 hover:bg-pink-200 text-pink-700 font-bold py-2 rounded-lg">
                                    +50
                                </button>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="resetReps()" class="quick-input-btn flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg text-sm">
                                    ãƒªã‚»ãƒƒãƒˆ
                                </button>
                                <button onclick="addReps(-1)" class="quick-input-btn bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-lg text-sm">
                                    -1
                                </button>
                                <button onclick="addReps(-10)" class="quick-input-btn bg-red-100 hover:bg-red-200 text-red-700 font-medium py-2 px-4 rounded-lg text-sm">
                                    -10
                                </button>
                            </div>
                        </div>
                        
                        <button 
                            id="save-record-btn"
                            class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                        >
                            âœ… è¨˜éŒ²ã™ã‚‹
                        </button>

                        <button 
                            id="set-today-btn"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors text-sm"
                        >
                            ä»Šæ—¥ã®æ—¥ä»˜ã«è¨­å®š
                        </button>
                    </div>
                </div>

                <!-- Goal Card -->
                <div class="glass-card rounded-2xl p-6 shadow-xl fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>ğŸ¯</span> ç›®æ¨™è¨­å®š
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                1æ—¥ã®ç›®æ¨™å›æ•°
                            </label>
                            <input 
                                type="number" 
                                id="daily-goal-input" 
                                placeholder="ä¾‹: 50"
                                min="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition text-lg font-semibold"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                æœˆé–“ã®ç›®æ¨™å›æ•°
                            </label>
                            <input 
                                type="number" 
                                id="monthly-goal-input" 
                                placeholder="ä¾‹: 1500"
                                min="1"
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition text-lg font-semibold"
                            >
                        </div>
                        
                        <button 
                            id="save-goal-btn"
                            class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                        >
                            ğŸ¯ ç›®æ¨™ã‚’ä¿å­˜
                        </button>

                        <div id="goal-display" class="space-y-2">
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-xs text-gray-600">æ—¥æ¬¡ç›®æ¨™: </span>
                                <span class="text-lg font-bold text-blue-600" id="current-daily-goal">æœªè¨­å®š</span>
                            </div>
                            <div class="text-center p-3 bg-purple-50 rounded-lg">
                                <span class="text-xs text-gray-600">æœˆæ¬¡ç›®æ¨™: </span>
                                <span class="text-lg font-bold text-purple-600" id="current-monthly-goal">æœªè¨­å®š</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Level Badge -->
                <div class="glass-card rounded-2xl p-6 shadow-xl text-center fade-in">
                    <div class="text-5xl mb-3" id="level-emoji">ğŸ¥š</div>
                    <div class="text-2xl font-bold text-gray-800 mb-1" id="level-name">åˆå¿ƒè€…</div>
                    <div class="text-sm text-gray-600" id="level-desc">å§‹ã‚ãŸã°ã‹ã‚Š</div>
                    <div class="mt-4">
                        <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div id="level-progress" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2" id="level-progress-text">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§: 0/100</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Calendar & Chart -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Calendar -->
                <div class="glass-card rounded-2xl p-6 shadow-xl fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <span>ğŸ“†</span> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                        </h2>
                        <div class="flex gap-2">
                            <button id="prev-month-btn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-sm font-medium">
                                â—€
                            </button>
                            <span id="current-month-display" class="px-4 py-1 font-semibold text-gray-700"></span>
                            <button id="next-month-btn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-sm font-medium">
                                â–¶
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        <div class="text-center text-xs font-semibold text-red-500">æ—¥</div>
                        <div class="text-center text-xs font-semibold text-gray-600">æœˆ</div>
                        <div class="text-center text-xs font-semibold text-gray-600">ç«</div>
                        <div class="text-center text-xs font-semibold text-gray-600">æ°´</div>
                        <div class="text-center text-xs font-semibold text-gray-600">æœ¨</div>
                        <div class="text-center text-xs font-semibold text-gray-600">é‡‘</div>
                        <div class="text-center text-xs font-semibold text-blue-500">åœŸ</div>
                    </div>
                    
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                        <!-- Calendar days will be generated here -->
                    </div>
                </div>

                <!-- Chart -->
                <div class="glass-card rounded-2xl p-6 shadow-xl fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>ğŸ“Š</span> å®Ÿç¸¾ã‚°ãƒ©ãƒ•ï¼ˆç›´è¿‘30æ—¥ï¼‰
                    </h2>
                    <div class="h-64">
                        <canvas id="performance-chart"></canvas>
                    </div>
                </div>

                <!-- Recent Records -->
                <div class="glass-card rounded-2xl p-6 shadow-xl fade-in">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>ğŸ“‹</span> æœ€è¿‘ã®è¨˜éŒ²
                    </h2>
                    <div id="recent-records" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-400 text-center py-4">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                </div>
            </div>
        </div>

        </div>
        </div>
        <!-- End Tracker Tab -->

        <!-- Visual Progress Tab -->
        <div id="visual-tab" class="tab-content hidden">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-end mb-4">
                    <button 
                        id="capture-btn"
                        class="glass-card px-6 py-3 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg flex items-center gap-2"
                    >
                        ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜
                    </button>
                </div>

                <div id="capture-area" class="capture-area fade-in">
                    <!-- Visual Stats Header -->
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">ğŸ’ª</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">è…¹ç­‹ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é€²æ—</h2>
                        <p class="text-gray-600" id="visual-date"></p>
                    </div>

                    <!-- Main Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-orange-100 to-orange-50 p-6 rounded-2xl text-center border-2 border-orange-200">
                            <div class="text-4xl mb-2">ğŸ”¥</div>
                            <div class="text-4xl font-bold text-orange-600" id="visual-streak">0</div>
                            <div class="text-sm text-gray-600 font-medium mt-1">é€£ç¶šæ—¥æ•°</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-blue-100 to-blue-50 p-6 rounded-2xl text-center border-2 border-blue-200">
                            <div class="text-4xl mb-2">ğŸ“…</div>
                            <div class="text-4xl font-bold text-blue-600" id="visual-total-days">0</div>
                            <div class="text-sm text-gray-600 font-medium mt-1">ç´¯è¨ˆå®Ÿæ–½æ—¥</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-100 to-purple-50 p-6 rounded-2xl text-center border-2 border-purple-200">
                            <div class="text-4xl mb-2">ğŸ’¯</div>
                            <div class="text-4xl font-bold text-purple-600" id="visual-total-reps">0</div>
                            <div class="text-sm text-gray-600 font-medium mt-1">ç´¯è¨ˆå›æ•°</div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-100 to-green-50 p-6 rounded-2xl text-center border-2 border-green-200">
                            <div class="text-4xl mb-2">â­</div>
                            <div class="text-4xl font-bold text-green-600" id="visual-average">0</div>
                            <div class="text-sm text-gray-600 font-medium mt-1">å¹³å‡å›æ•°</div>
                        </div>
                    </div>

                    <!-- Level Display -->
                    <div class="bg-gradient-to-br from-yellow-100 to-orange-100 p-8 rounded-2xl mb-8 text-center border-2 border-yellow-200">
                        <div class="text-7xl mb-4" id="visual-level-emoji">ğŸ¥š</div>
                        <div class="text-3xl font-bold text-gray-800 mb-2" id="visual-level-name">åˆå¿ƒè€…</div>
                        <div class="text-gray-700 mb-4" id="visual-level-desc">å§‹ã‚ãŸã°ã‹ã‚Š</div>
                        <div class="max-w-md mx-auto">
                            <div class="bg-white rounded-full h-4 overflow-hidden shadow-inner">
                                <div id="visual-level-progress" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div class="text-sm text-gray-700 mt-2 font-medium" id="visual-level-progress-text">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§: 0/100</div>
                        </div>
                    </div>

                    <!-- Monthly Progress -->
                    <div class="bg-gradient-to-br from-pink-100 to-purple-100 p-8 rounded-2xl border-2 border-pink-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">ä»Šæœˆã®é€²æ—</h3>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-gray-700 font-medium">æœˆé–“å®Ÿç¸¾</span>
                            <span class="text-2xl font-bold text-purple-600" id="visual-month-reps">0</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-gray-700 font-medium">æœˆé–“ç›®æ¨™</span>
                            <span class="text-2xl font-bold text-pink-600" id="visual-month-goal">-</span>
                        </div>
                        <div class="bg-white rounded-full h-6 overflow-hidden shadow-inner mb-3">
                            <div id="visual-month-progress" class="bg-gradient-to-r from-pink-500 to-purple-500 h-full transition-all duration-500 flex items-center justify-center" style="width: 0%">
                                <span class="text-xs font-bold text-white" id="visual-month-percent"></span>
                            </div>
                        </div>
                        <div class="text-center">
                            <span class="text-sm text-gray-600" id="visual-month-status">ç›®æ¨™é”æˆã¾ã§ã‚ã¨ 0 å›</span>
                        </div>
                    </div>

                    <!-- Watermark -->
                    <div class="text-center mt-8 text-gray-400 text-sm">
                        è…¹ç­‹ãƒãƒ“ãƒƒãƒˆãƒˆãƒ©ãƒƒã‚«ãƒ¼ ğŸ’ª
                    </div>
                </div>
            </div>
        </div>
        <!-- End Visual Tab -->

        <!-- Footer -->
        <footer class="text-center mt-8 text-white/60 text-sm">
            <p>ç¶™ç¶šã¯åŠ›ãªã‚Š ğŸ’ª æ¯æ—¥ã‚³ãƒ„ã‚³ãƒ„é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</p>
        </footer>
    </div>

    <script>
        // State Management
        const state = {
            records: {}, // { "YYYY-MM-DD": reps }
            dailyGoal: 50,
            monthlyGoal: 1500,
            currentMonth: new Date(),
            levels: [
                { name: 'åˆå¿ƒè€…', emoji: 'ğŸ¥š', threshold: 0, desc: 'å§‹ã‚ãŸã°ã‹ã‚Š' },
                { name: 'è¦‹ç¿’ã„', emoji: 'ğŸ£', threshold: 100, desc: 'ç¿’æ…£åŒ–ã®ç¬¬ä¸€æ­©' },
                { name: 'ä¸­ç´šè€…', emoji: 'ğŸ¥', threshold: 300, desc: 'ç¶™ç¶šã§ãã¦ã„ã‚‹' },
                { name: 'ä¸Šç´šè€…', emoji: 'ğŸ¦…', threshold: 700, desc: 'ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›' },
                { name: 'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ', emoji: 'ğŸ¦¸', threshold: 1500, desc: 'è…¹ç­‹ãƒã‚¹ã‚¿ãƒ¼' },
                { name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', emoji: 'ğŸ‘‘', threshold: 3000, desc: 'ä¼èª¬ã®åŸŸ' },
                { name: 'ç¥', emoji: 'âœ¨', threshold: 5000, desc: 'è…¹ç­‹ã®ç¥' }
            ]
        };

        let chartInstance = null;

        // Utility Functions
        const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const formatDateDisplay = (dateStr) => {
            const [y, m, d] = dateStr.split('-');
            return `${m}/${d}`;
        };

        const saveState = () => {
            localStorage.setItem('abdominalTrackerState', JSON.stringify({
                records: state.records,
                dailyGoal: state.dailyGoal,
                monthlyGoal: state.monthlyGoal
            }));
        };

        const loadState = () => {
            const saved = localStorage.getItem('abdominalTrackerState');
            if (saved) {
                const data = JSON.parse(saved);
                state.records = data.records || {};
                state.dailyGoal = data.dailyGoal || data.goal || 50; // å¾Œæ–¹äº’æ›æ€§
                state.monthlyGoal = data.monthlyGoal || 1500;
            }
        };

        // Statistics Calculation
        const calculateStats = () => {
            const dates = Object.keys(state.records).sort();
            const totalDays = dates.length;
            const totalReps = Object.values(state.records).reduce((sum, reps) => sum + reps, 0);
            const averageReps = totalDays > 0 ? Math.round(totalReps / totalDays) : 0;

            // Calculate streak
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let checkDate = new Date(today);
            while (true) {
                const dateStr = formatDate(checkDate);
                if (state.records[dateStr]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return { totalDays, totalReps, averageReps, streak };
        };

        const getCurrentLevel = (totalReps) => {
            let currentLevel = state.levels[0];
            let nextLevel = state.levels[1];

            for (let i = state.levels.length - 1; i >= 0; i--) {
                if (totalReps >= state.levels[i].threshold) {
                    currentLevel = state.levels[i];
                    nextLevel = state.levels[i + 1] || null;
                    break;
                }
            }

            const progress = nextLevel 
                ? ((totalReps - currentLevel.threshold) / (nextLevel.threshold - currentLevel.threshold)) * 100
                : 100;

            return { currentLevel, nextLevel, progress };
        };

        // UI Update Functions
        const updateStats = () => {
            const stats = calculateStats();
            
            document.getElementById('streak-count').textContent = stats.streak;
            document.getElementById('total-days').textContent = stats.totalDays;
            document.getElementById('total-reps').textContent = stats.totalReps;
            document.getElementById('average-reps').textContent = stats.averageReps;

            // Update level
            const { currentLevel, nextLevel, progress } = getCurrentLevel(stats.totalReps);
            document.getElementById('level-emoji').textContent = currentLevel.emoji;
            document.getElementById('level-name').textContent = currentLevel.name;
            document.getElementById('level-desc').textContent = currentLevel.desc;
            document.getElementById('level-progress').style.width = `${progress}%`;
            
            if (nextLevel) {
                const remaining = nextLevel.threshold - stats.totalReps;
                document.getElementById('level-progress-text').textContent = 
                    `æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã€Œ${nextLevel.name}ã€ã¾ã§ã‚ã¨ ${remaining} å›`;
            } else {
                document.getElementById('level-progress-text').textContent = 'æœ€é«˜ãƒ¬ãƒ™ãƒ«é”æˆï¼';
            }
        };

        const renderCalendar = () => {
            const year = state.currentMonth.getFullYear();
            const month = state.currentMonth.getMonth();
            
            document.getElementById('current-month-display').textContent = 
                `${year}å¹´${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Empty cells before first day
            for (let i = 0; i < startDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day bg-gray-100 rounded-lg';
                grid.appendChild(cell);
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const reps = state.records[dateStr];
                const hasRecord = !!reps;
                const goalMet = reps >= state.dailyGoal;

                const cell = document.createElement('div');
                cell.className = `calendar-day rounded-lg cursor-pointer flex flex-col items-center justify-center text-sm font-semibold ${
                    hasRecord 
                        ? (goalMet ? 'completed text-white' : 'bg-pink-200 text-pink-800')
                        : 'bg-white hover:bg-gray-50'
                }`;
                
                const dayNum = document.createElement('div');
                dayNum.textContent = day;
                cell.appendChild(dayNum);

                if (hasRecord) {
                    const repsDiv = document.createElement('div');
                    repsDiv.className = 'text-xs opacity-90 mt-1';
                    repsDiv.textContent = `${reps}å›`;
                    cell.appendChild(repsDiv);

                    if (goalMet) {
                        const star = document.createElement('div');
                        star.textContent = 'â­';
                        star.className = 'text-xs';
                        cell.appendChild(star);
                    }
                }

                cell.addEventListener('click', () => {
                    document.getElementById('record-date').value = dateStr;
                    if (hasRecord) {
                        document.getElementById('reps-input').value = reps;
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                grid.appendChild(cell);
            }
        };

        const renderChart = () => {
            const today = new Date();
            const last30Days = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last30Days.push(formatDate(date));
            }

            const labels = last30Days.map(d => formatDateDisplay(d));
            const data = last30Days.map(d => state.records[d] || 0);
            const goalLine = new Array(30).fill(state.dailyGoal);

            const ctx = document.getElementById('performance-chart');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'è…¹ç­‹å›æ•°',
                            data: data,
                            backgroundColor: data.map(v => 
                                v >= state.dailyGoal 
                                    ? 'rgba(168, 85, 247, 0.8)' 
                                    : 'rgba(236, 72, 153, 0.6)'
                            ),
                            borderColor: data.map(v => 
                                v >= state.dailyGoal 
                                    ? 'rgba(168, 85, 247, 1)' 
                                    : 'rgba(236, 72, 153, 1)'
                            ),
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'ç›®æ¨™ãƒ©ã‚¤ãƒ³',
                            data: goalLine,
                            type: 'line',
                            borderColor: 'rgba(59, 130, 246, 0.8)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        };

        const renderRecentRecords = () => {
            const container = document.getElementById('recent-records');
            const sortedDates = Object.keys(state.records).sort().reverse().slice(0, 10);

            if (sortedDates.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = sortedDates.map(dateStr => {
                const reps = state.records[dateStr];
                const goalMet = reps >= state.dailyGoal;
                const [y, m, d] = dateStr.split('-');
                const displayDate = `${y}å¹´${m}æœˆ${d}æ—¥`;

                return `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${goalMet ? 'â­' : 'ğŸ’ª'}</span>
                            <div>
                                <div class="font-semibold text-gray-800">${displayDate}</div>
                                <div class="text-sm text-gray-500">${reps}å› ${goalMet ? '(ç›®æ¨™é”æˆ!)' : ''}</div>
                            </div>
                        </div>
                        <button 
                            onclick="deleteRecord('${dateStr}')"
                            class="text-red-500 hover:text-red-700 text-sm font-medium px-3 py-1 rounded hover:bg-red-50 transition"
                        >
                            å‰Šé™¤
                        </button>
                    </div>
                `;
            }).join('');
        };

        const render = () => {
            updateStats();
            renderCalendar();
            renderChart();
            renderRecentRecords();
            document.getElementById('current-daily-goal').textContent = `${state.dailyGoal}å›`;
            document.getElementById('current-monthly-goal').textContent = `${state.monthlyGoal}å›`;
            document.getElementById('daily-goal-input').value = state.dailyGoal;
            document.getElementById('monthly-goal-input').value = state.monthlyGoal;
        };

        // Quick Input Functions
        const addReps = (amount) => {
            const input = document.getElementById('reps-input');
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(0, currentValue + amount);
            input.value = newValue;
        };

        const resetReps = () => {
            document.getElementById('reps-input').value = '';
        };

        // Tab Switching
        const switchTab = (tabName) => {
            const trackerTab = document.getElementById('tracker-tab');
            const visualTab = document.getElementById('visual-tab');
            const trackerBtn = document.getElementById('tab-tracker');
            const visualBtn = document.getElementById('tab-visual');

            if (tabName === 'tracker') {
                trackerTab.classList.remove('hidden');
                visualTab.classList.add('hidden');
                trackerBtn.classList.add('active');
                visualBtn.classList.remove('active');
            } else if (tabName === 'visual') {
                visualTab.classList.remove('hidden');
                trackerTab.classList.add('hidden');
                visualBtn.classList.add('active');
                trackerBtn.classList.remove('active');
                updateVisualTab();
            }
        };

        // Event Handlers
        const saveRecord = () => {
            const dateStr = document.getElementById('record-date').value;
            const reps = parseInt(document.getElementById('reps-input').value, 10);

            if (!dateStr) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (isNaN(reps) || reps <= 0) {
                alert('æ­£ã—ã„å›æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            state.records[dateStr] = reps;
            saveState();
            render();
            
            document.getElementById('reps-input').value = '';
            
            // Success animation
            const btn = document.getElementById('save-record-btn');
            btn.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
            setTimeout(() => {
                btn.textContent = 'âœ… è¨˜éŒ²ã™ã‚‹';
            }, 2000);
        };

        const saveGoal = () => {
            const dailyGoal = parseInt(document.getElementById('daily-goal-input').value, 10);
            const monthlyGoal = parseInt(document.getElementById('monthly-goal-input').value, 10);
            
            if ((isNaN(dailyGoal) || dailyGoal <= 0) && (isNaN(monthlyGoal) || monthlyGoal <= 0)) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!isNaN(dailyGoal) && dailyGoal > 0) {
                state.dailyGoal = dailyGoal;
            }
            if (!isNaN(monthlyGoal) && monthlyGoal > 0) {
                state.monthlyGoal = monthlyGoal;
            }
            
            saveState();
            render();

            const btn = document.getElementById('save-goal-btn');
            btn.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
            setTimeout(() => {
                btn.textContent = 'ğŸ¯ ç›®æ¨™ã‚’ä¿å­˜';
            }, 2000);
        };

        const deleteRecord = (dateStr) => {
            if (confirm(`${dateStr}ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete state.records[dateStr];
                saveState();
                render();
            }
        };

        const changeMonth = (delta) => {
            state.currentMonth.setMonth(state.currentMonth.getMonth() + delta);
            renderCalendar();
        };

        const setToday = () => {
            document.getElementById('record-date').value = formatDate(new Date());
        };

        // Initialize
        const init = () => {
            loadState();
            
            // Set today's date
            document.getElementById('record-date').value = formatDate(new Date());

            // Event Listeners
            document.getElementById('save-record-btn').addEventListener('click', saveRecord);
            document.getElementById('save-goal-btn').addEventListener('click', saveGoal);
            document.getElementById('set-today-btn').addEventListener('click', setToday);
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
            document.getElementById('tab-tracker').addEventListener('click', () => switchTab('tracker'));
            document.getElementById('tab-visual').addEventListener('click', () => switchTab('visual'));
            document.getElementById('capture-btn').addEventListener('click', captureScreenshot);

            // Enter key support
            document.getElementById('reps-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveRecord();
            });
            document.getElementById('goal-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveGoal();
            });

            // Initial render
            render();
        };

        // Visual Tab Update
        const updateVisualTab = () => {
            const stats = calculateStats();
            const { currentLevel, nextLevel, progress } = getCurrentLevel(stats.totalReps);
            
            // Update date
            const now = new Date();
            document.getElementById('visual-date').textContent = 
                `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ç¾åœ¨`;
            
            // Update stats
            document.getElementById('visual-streak').textContent = stats.streak;
            document.getElementById('visual-total-days').textContent = stats.totalDays;
            document.getElementById('visual-total-reps').textContent = stats.totalReps;
            document.getElementById('visual-average').textContent = stats.averageReps;
            
            // Update level
            document.getElementById('visual-level-emoji').textContent = currentLevel.emoji;
            document.getElementById('visual-level-name').textContent = currentLevel.name;
            document.getElementById('visual-level-desc').textContent = currentLevel.desc;
            document.getElementById('visual-level-progress').style.width = `${progress}%`;
            
            if (nextLevel) {
                const remaining = nextLevel.threshold - stats.totalReps;
                document.getElementById('visual-level-progress-text').textContent = 
                    `æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã€Œ${nextLevel.name}ã€ã¾ã§ã‚ã¨ ${remaining} å›`;
            } else {
                document.getElementById('visual-level-progress-text').textContent = 'æœ€é«˜ãƒ¬ãƒ™ãƒ«é”æˆï¼';
            }
            
            // Calculate monthly stats
            const year = now.getFullYear();
            const month = now.getMonth();
            const monthlyReps = Object.keys(state.records)
                .filter(dateStr => {
                    const date = new Date(dateStr);
                    return date.getFullYear() === year && date.getMonth() === month;
                })
                .reduce((sum, dateStr) => sum + state.records[dateStr], 0);
            
            document.getElementById('visual-month-reps').textContent = monthlyReps;
            document.getElementById('visual-month-goal').textContent = `${state.monthlyGoal}å›`;
            
            const monthProgress = Math.min((monthlyReps / state.monthlyGoal) * 100, 100);
            document.getElementById('visual-month-progress').style.width = `${monthProgress}%`;
            document.getElementById('visual-month-percent').textContent = 
                monthProgress >= 10 ? `${monthProgress.toFixed(0)}%` : '';
            
            const remaining = Math.max(0, state.monthlyGoal - monthlyReps);
            if (remaining > 0) {
                document.getElementById('visual-month-status').textContent = 
                    `ç›®æ¨™é”æˆã¾ã§ã‚ã¨ ${remaining} å›`;
            } else {
                document.getElementById('visual-month-status').textContent = 
                    `ğŸ‰ ç›®æ¨™é”æˆï¼ +${monthlyReps - state.monthlyGoal} å›ã‚ªãƒ¼ãƒãƒ¼é”æˆï¼`;
            }
        };

        // Capture Screenshot
        const captureScreenshot = async () => {
            const captureArea = document.getElementById('capture-area');
            const button = document.getElementById('capture-btn');
            
            button.textContent = 'ğŸ“¸ ç”Ÿæˆä¸­...';
            button.disabled = true;
            
            try {
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                // Convert to blob and download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const now = new Date();
                    const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                    link.download = `è…¹ç­‹é€²æ—_${dateStr}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    button.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
                    setTimeout(() => {
                        button.textContent = 'ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜';
                        button.disabled = false;
                    }, 2000);
                });
            } catch (error) {
                console.error('Screenshot failed:', error);
                alert('ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                button.textContent = 'ğŸ“¸ ç”»åƒã¨ã—ã¦ä¿å­˜';
                button.disabled = false;
            }
        };

        // Make functions available globally
        window.deleteRecord = deleteRecord;
        window.addReps = addReps;
        window.resetReps = resetReps;

        // Start app
        init();
    </script>
</body>
</html>
