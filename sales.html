<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Voyage - å£²ä¸Šç›®æ¨™é”æˆã®å†’é™º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F8FF; /* AliceBlue for a light, airy feel */
        }
        .font-brand {
            font-family: 'Mochiy Pop One', sans-serif;
        }
        #voyage-map {
            background: linear-gradient(to bottom, #87CEEB 0%, #4682B4 100%); /* SkyBlue to SteelBlue gradient */
            position: relative;
            height: 150px;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        #ship {
            position: absolute;
            bottom: 20px;
            left: 2%; /* Start near the beginning */
            font-size: 3rem;
            transition: left 1s ease-in-out;
            transform: translateX(-50%);
        }
        #island {
            position: absolute;
            bottom: 15px;
            right: 2%;
            font-size: 4rem;
        }
        .sun-rays {
            animation: spin 20s linear infinite;
            transform-origin: center;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .tab-btn.active {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-3xl shadow-lg">

        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-brand text-slate-800">Sales Voyage â›µ</h1>
            <p class="text-slate-500 mt-2">ä¼èª¬ã®å®å³¶ï¼ˆå£²ä¸Šç›®æ¨™ï¼‰ã‚’ç›®æŒ‡ã™å¤§èˆªæµ·ï¼</p>
        </header>

        <!-- Tabs -->
        <div class="mb-6 border-b border-slate-200">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button id="daily-tab-btn" class="tab-btn active w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-slate-500 hover:text-blue-600 hover:border-blue-300 transition-colors">
                    ãƒ‡ã‚¤ãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
                </button>
                <button id="monthly-tab-btn" class="tab-btn w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm text-slate-500 hover:text-blue-600 hover:border-blue-300 transition-colors">
                    ãƒãƒ³ã‚¹ãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div>
            <!-- Daily Tab Content -->
            <div id="daily-tab-content">
                <!-- Voyage Plan -->
                <div class="bg-slate-50 p-6 rounded-2xl mb-6">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">èˆªæµ·è¨ˆç”»ã‚’ç«‹ã¦ã‚‹</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="start-date-input" class="block text-sm font-medium text-slate-600 mb-1">é–‹å§‹æ—¥</label>
                            <input type="date" id="start-date-input" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label for="end-date-input" class="block text-sm font-medium text-slate-600 mb-1">çµ‚äº†æ—¥</label>
                            <input type="date" id="end-date-input" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label for="budget-input" class="block text-sm font-medium text-slate-600 mb-1">æœŸé–“ã®äºˆç®—</label>
                            <input type="number" id="budget-input" placeholder="äºˆç®—ã‚’å…¥åŠ›" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                         <button id="set-this-month-btn" class="w-full sm:w-auto bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-8 rounded-lg transition">
                            å½“æœˆ
                        </button>
                        <button id="set-budget-btn" class="w-full sm:flex-grow bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                            èˆªæµ·è¨ˆç”»ã‚’æ±ºå®šï¼
                        </button>
                    </div>
                </div>

                <!-- Dashboard (æ“èˆµå®¤) -->
                <div class="bg-slate-50 p-6 rounded-2xl mb-6">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">æ“èˆµå®¤</h2>
                    <div id="voyage-map">
                        <div id="weather-icon" class="absolute top-2 text-4xl transform -translate-x-1/2 transition-all duration-1000 ease-in-out"></div>
                        <div id="ship">ğŸš¢</div>
                        <div id="island">ğŸï¸</div>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-4 mt-4 overflow-hidden">
                        <div id="progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-1000 ease-in-out" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-slate-500">ãŠå¤©æ°—</p><p id="weather-text" class="text-xl font-bold text-slate-800">-</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-slate-500">æœŸé–“ã®äºˆç®—</p><p id="sales-goal" class="text-xl font-bold text-slate-800">Â¥0</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-slate-500">ç¾åœ¨å£²ä¸Š</p><p id="current-sales" class="text-xl font-bold text-slate-800">-</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-slate-500">é”æˆç‡</p><p id="achievement-rate" class="text-xl font-bold text-green-600">-</p></div>
                    </div>
                </div>

                <!-- Controls (èˆªæµ·æ—¥èªŒ) -->
                <div class="bg-slate-50 p-6 rounded-2xl mb-6">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">èˆªæµ·æ—¥èªŒã‚’ã¤ã‘ã‚‹</h2>
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <input type="date" id="date-input" class="w-full sm:w-auto px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <button id="set-today-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 px-4 rounded-lg transition">TODAY</button>
                        <input type="number" id="sales-input" placeholder="å£²ä¸Šã‚’å…¥åŠ› (ä¾‹: 50000)" class="flex-grow px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <button id="log-sales-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 shadow-md">å®Ÿç¸¾ã‚’è¨˜éŒ²ï¼</button>
                    </div>
                </div>

                <!-- Voyage Report -->
                <div class="bg-slate-50 p-6 rounded-2xl mb-6">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">èˆªæµ·ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                    <div class="h-64"><canvas id="sales-chart"></canvas></div>
                </div>

                <!-- Player Info & Log -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-50 p-6 rounded-2xl">
                        <h3 class="text-xl font-bold text-slate-700 mb-4">èˆ¹å“¡ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                        <div class="flex items-center gap-4">
                            <div id="player-icon" class="text-4xl">ğŸ›¶</div>
                            <div><p id="player-rank" class="text-slate-500 text-lg">ãƒ©ãƒ³ã‚¯: è¦‹ç¿’ã„æ°´å¤«</p></div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-slate-600 mb-1">æ¬¡ã®ãƒ©ãƒ³ã‚¯ã¾ã§ã®çµŒé¨“å€¤ (EXP)</p>
                            <div class="w-full bg-slate-200 rounded-full h-3"><div id="exp-bar" class="bg-amber-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                            <p id="exp-text" class="text-xs text-right text-slate-500 mt-1">0 / 100</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 p-6 rounded-2xl">
                        <h3 class="text-xl font-bold text-slate-700 mb-4">å‡ºæ¥äº‹ãƒ­ã‚°</h3>
                        <div id="log-area" class="h-40 overflow-y-auto bg-white p-3 rounded-lg border border-slate-200"><p class="text-slate-400">ã¾ã å†’é™ºã¯å§‹ã¾ã£ã¦ã„ãªã„...</p></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Tab Content -->
            <div id="monthly-tab-content" class="hidden">
                <div class="bg-slate-50 p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold text-slate-700 mb-4">æœˆæ¬¡èˆªæµ·ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                    <p class="text-sm text-slate-500 mb-4">å„æœˆã®äºˆç®—ã¨å®Ÿç¸¾ã®åˆè¨ˆã§ã™ã€‚äºˆç®—ã¯ã€ãã®æœˆã«é–‹å§‹ã•ã‚ŒãŸèˆªæµ·è¨ˆç”»ã®åˆè¨ˆã§ã™ã€‚</p>
                    <div class="h-96">
                      <canvas id="monthly-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Game State ---
            const state = {
                currentVoyage: { // ç¾åœ¨é€²è¡Œä¸­ã®èˆªæµ·è¨ˆç”»
                    salesGoal: 0,
                    startDate: null,
                    endDate: null,
                },
                voyageHistory: [], // { startDate, endDate, salesGoal } éå»ã®å…¨è¨ˆç”»
                salesRecords: [], // { id, amount, date, timestamp }
                ranks: [
                    { name: 'è¦‹ç¿’ã„æ°´å¤«', icon: 'ğŸ›¶' }, { name: 'ç”²æ¿å“¡', icon: 'ğŸ§¹' }, { name: 'æ“èˆµæ‰‹', icon: 'â˜¸ï¸' },
                    { name: 'ä¸‰ç­‰èˆªæµ·å£«', icon: 'ğŸ§­' }, { name: 'äºŒç­‰èˆªæµ·å£«', icon: 'ğŸ”­' }, { name: 'ä¸€ç­‰èˆªæµ·å£«', icon: 'ğŸ—ºï¸' },
                    { name: 'èˆªæµ·é•·', icon: 'âœ¨' }, { name: 'å‰¯èˆ¹é•·', icon: 'âš“ï¸' }, { name: 'èˆ¹é•·', icon: 'ğŸ‘‘' }, { name: 'æµ·ã®ä¼èª¬', icon: 'ğŸ”±' }
                ],
                expRates: { base: 100, multiplier: 1.5 }
            };

            let dailyChartInstance = null;
            let monthlyChartInstance = null;

            // --- DOM Elements ---
            const DOMElements = {
                salesGoal: document.getElementById('sales-goal'),
                currentSales: document.getElementById('current-sales'),
                achievementRate: document.getElementById('achievement-rate'),
                progressBar: document.getElementById('progress-bar'),
                ship: document.getElementById('ship'),
                weatherIcon: document.getElementById('weather-icon'),
                weatherText: document.getElementById('weather-text'),
                salesInput: document.getElementById('sales-input'),
                dateInput: document.getElementById('date-input'),
                logSalesBtn: document.getElementById('log-sales-btn'),
                budgetInput: document.getElementById('budget-input'),
                setBudgetBtn: document.getElementById('set-budget-btn'),
                startDateInput: document.getElementById('start-date-input'),
                endDateInput: document.getElementById('end-date-input'),
                playerIcon: document.getElementById('player-icon'),
                playerRank: document.getElementById('player-rank'),
                expBar: document.getElementById('exp-bar'),
                expText: document.getElementById('exp-text'),
                logArea: document.getElementById('log-area'),
                dailyChartCanvas: document.getElementById('sales-chart'),
                monthlyChartCanvas: document.getElementById('monthly-chart'),
                dailyTabBtn: document.getElementById('daily-tab-btn'),
                monthlyTabBtn: document.getElementById('monthly-tab-btn'),
                dailyTabContent: document.getElementById('daily-tab-content'),
                monthlyTabContent: document.getElementById('monthly-tab-content'),
                setThisMonthBtn: document.getElementById('set-this-month-btn'),
                setTodayBtn: document.getElementById('set-today-btn'),
            };
            
            // --- Persistence (ãƒ‡ãƒ¼ã‚¿ä¿å­˜) ---
            const STORAGE_KEY = 'salesVoyageState_v2';

            const saveState = () => {
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } 
                catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e); }
            };

            const loadState = () => {
                try {
                    const savedState = localStorage.getItem(STORAGE_KEY);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        // Ensure nested objects exist to avoid errors with older data structures
                        state.currentVoyage = parsedState.currentVoyage || { salesGoal: 0, startDate: null, endDate: null };
                        state.voyageHistory = parsedState.voyageHistory || [];
                        state.salesRecords = parsedState.salesRecords || [];
                        return true;
                    }
                    return false;
                } catch (e) {
                    console.error("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
                    return false;
                }
            };

            // --- Tab Switching ---
            const switchTab = (tab) => {
                if (tab === 'daily') {
                    DOMElements.dailyTabBtn.classList.add('active');
                    DOMElements.monthlyTabBtn.classList.remove('active');
                    DOMElements.dailyTabContent.classList.remove('hidden');
                    DOMElements.monthlyTabContent.classList.add('hidden');
                } else if (tab === 'monthly') {
                    DOMElements.monthlyTabBtn.classList.add('active');
                    DOMElements.dailyTabBtn.classList.remove('active');
                    DOMElements.monthlyTabContent.classList.remove('hidden');
                    DOMElements.dailyTabContent.classList.add('hidden');
                    renderMonthlyReport();
                }
            };

            // --- Functions ---
            const renderLogs = () => {
                const log = DOMElements.logArea;
                log.innerHTML = '';
                if (state.salesRecords.length === 0) {
                    log.innerHTML = '<p class="text-slate-400">ã¾ã å†’é™ºã¯å§‹ã¾ã£ã¦ã„ãªã„...</p>';
                    return;
                }
                const sortedRecords = [...state.salesRecords].sort((a,b) => new Date(b.date) - new Date(a.date) || b.timestamp - a.timestamp);
                sortedRecords.forEach(record => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'flex justify-between items-center p-2 border-b border-slate-100 text-sm';
                    const date = new Date(record.date);
                    const displayDate = `${date.getUTCMonth() + 1}/${date.getUTCDate()}`;
                    logEntry.innerHTML = `<span><span class="font-semibold text-green-600">+ Â¥${record.amount.toLocaleString()}</span><span class="text-xs text-slate-400 ml-2">${displayDate}</span></span><button data-id="${record.id}" class="delete-btn text-red-500 hover:text-red-700 text-xs font-bold py-1 px-2 rounded">&times; å‰Šé™¤</button>`;
                    log.appendChild(logEntry);
                });
                document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', (e) => handleDeleteRecord(e.target.getAttribute('data-id'))));
            };
            
            const updatePlayerInfo = (recalculatedState) => {
                const { currentRank, exp, expToNextLevel } = recalculatedState.playerStats;
                DOMElements.playerIcon.textContent = currentRank.icon;
                DOMElements.playerRank.textContent = `ãƒ©ãƒ³ã‚¯: ${currentRank.name}`;
                const expPercent = Math.min((exp / expToNextLevel) * 100, 100);
                DOMElements.expBar.style.width = `${expPercent}%`;
                DOMElements.expText.textContent = `${exp} / ${expToNextLevel}`;
            };

            const updateWeather = (rate) => {
                let weather = {};
                if (rate >= 100) weather = { icon: 'â˜€ï¸', text: 'å¿«æ™´', bgColor: 'linear-gradient(to bottom, #87CEEB 0%, #4682B4 100%)'};
                else if (rate >= 80) weather = { icon: 'ğŸŒ¤ï¸', text: 'æ™´ã‚Œ', bgColor: 'linear-gradient(to bottom, #A1D5F0 0%, #6F90B1 100%)'};
                else if (rate >= 50) weather = { icon: 'â˜ï¸', text: 'æ›‡ã‚Š', bgColor: 'linear-gradient(to bottom, #B0C4DE 0%, #778899 100%)'};
                else weather = { icon: 'â›ˆï¸', text: 'åµ', bgColor: 'linear-gradient(to bottom, #708090 0%, #2F4F4F 100%)'};
                
                if (rate >= 100 && !DOMElements.weatherIcon.querySelector('.sun-rays')) {
                    const sun = document.createElement('div'); sun.className = 'sun-rays'; sun.textContent = 'â˜€ï¸';
                    DOMElements.weatherIcon.innerHTML = ''; DOMElements.weatherIcon.appendChild(sun);
                } else if (rate < 100) {
                    DOMElements.weatherIcon.innerHTML = weather.icon;
                }
                DOMElements.weatherText.textContent = weather.text;
                document.getElementById('voyage-map').style.background = weather.bgColor;
            };
            
            const updateDailyChart = () => {
                const { salesGoal, startDate, endDate } = state.currentVoyage;
                const sortedRecords = [...state.salesRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                const dailyTotals = new Map();
                sortedRecords.forEach(record => dailyTotals.set(record.date, (dailyTotals.get(record.date) || 0) + record.amount));
                
                let cumulativeSales = 0;
                const labels = ['é–‹å§‹']; const salesData = [0];
                Array.from(dailyTotals.keys()).sort((a,b) => new Date(a) - new Date(b)).forEach(date => {
                    cumulativeSales += dailyTotals.get(date);
                    const d = new Date(date);
                    labels.push(`${d.getUTCMonth() + 1}/${d.getUTCDate()}`);
                    salesData.push(cumulativeSales);
                });

                let budgetData = []; let budgetLabel = 'äºˆç®—ãƒšãƒ¼ã‚¹';
                if (startDate && endDate && salesGoal > 0) {
                    const startDateMs = new Date(startDate).getTime();
                    const totalDurationMs = new Date(endDate).getTime() - startDateMs;
                    if (totalDurationMs > 0) {
                        budgetData = labels.map(label => {
                            if (label === 'é–‹å§‹') return 0;
                            const [month, day] = label.split('/');
                            // Assuming current year for date parsing
                            const currentYear = new Date(startDate).getFullYear();
                            const currentDate = new Date(currentYear, month-1, day);
                            const elapsedMs = currentDate.getTime() - startDateMs;
                            return salesGoal * Math.min(Math.max(0, elapsedMs / totalDurationMs), 1.0);
                        });
                    }
                }

                if (!dailyChartInstance) {
                    const ctx = DOMElements.dailyChartCanvas.getContext('2d');
                    dailyChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets: [
                            { 
                                label: budgetLabel, 
                                data: budgetData, 
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                fill: true,
                                tension: 0.1,
                                pointRadius: 0
                            },
                            { 
                                label: 'ç´¯ç©å£²ä¸Šé«˜', 
                                data: salesData, 
                                fill: true, 
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgb(54, 162, 235)', 
                                tension: 0.1 
                            }
                        ]},
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: salesGoal > 0 ? salesGoal : undefined, ticks: { callback: (v) => salesGoal <= 0 ? '' : `Â¥${v/1000}k` }}}}
                    });
                } else {
                    dailyChartInstance.data.labels = labels;
                    dailyChartInstance.data.datasets[0].data = budgetData;
                    dailyChartInstance.data.datasets[0].label = budgetLabel;
                    dailyChartInstance.data.datasets[1].data = salesData;
                    dailyChartInstance.options.scales.y.max = salesGoal > 0 ? salesGoal : undefined;
                    dailyChartInstance.update();
                }
            };
            
            const renderMonthlyReport = () => {
                const monthlyData = {};
                // Aggregate actual sales
                state.salesRecords.forEach(rec => {
                    const monthKey = rec.date.substring(0, 7); // YYYY-MM
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = { budget: 0, actual: 0 };
                    monthlyData[monthKey].actual += rec.amount;
                });
                // Aggregate budgets
                state.voyageHistory.forEach(voyage => {
                    if(voyage.startDate) {
                        const monthKey = voyage.startDate.substring(0, 7);
                        if (!monthlyData[monthKey]) monthlyData[monthKey] = { budget: 0, actual: 0 };
                        monthlyData[monthKey].budget += voyage.salesGoal;
                    }
                });

                const sortedKeys = Object.keys(monthlyData).sort();
                const labels = sortedKeys.map(key => `${key.substring(0, 4)}å¹´${parseInt(key.substring(5, 7))}æœˆ`);
                const budgetDataset = sortedKeys.map(key => monthlyData[key].budget);
                const actualDataset = sortedKeys.map(key => monthlyData[key].actual);

                if (!monthlyChartInstance) {
                    const ctx = DOMElements.monthlyChartCanvas.getContext('2d');
                    monthlyChartInstance = new Chart(ctx, {
                        type: 'line', 
                        data: {
                            labels,
                            datasets: [
                                { 
                                    label: 'äºˆç®—', 
                                    data: budgetDataset, 
                                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                    borderColor: 'rgb(255, 99, 132)',
                                    fill: true,
                                    tension: 0.1
                                },
                                { 
                                    label: 'å®Ÿç¸¾', 
                                    data: actualDataset, 
                                    backgroundColor: 'rgba(54, 162, 235, 0.5)', // Increased opacity
                                    borderColor: 'rgb(54, 162, 235)',
                                    fill: true,
                                    tension: 0.1
                                }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    ticks: { 
                                        callback: (v) => labels.length > 0 ? `Â¥${v/1000}k` : ''
                                    } 
                                } 
                            } 
                        }
                    });
                } else {
                    monthlyChartInstance.data.labels = labels;
                    monthlyChartInstance.data.datasets[0].data = budgetDataset;
                    monthlyChartInstance.data.datasets[1].data = actualDataset;
                    monthlyChartInstance.update();
                }
            };

            const recalculateState = () => {
                let totalSales = state.salesRecords.reduce((sum, record) => sum + record.amount, 0);
                let totalExp = Math.floor(totalSales / 1000);
                let currentRankIndex = 0; let exp = totalExp;
                let expToNextLevel = state.expRates.base;
                while (exp >= expToNextLevel && currentRankIndex < state.ranks.length - 1) {
                    exp -= expToNextLevel;
                    currentRankIndex++;
                    expToNextLevel = Math.floor(expToNextLevel * state.expRates.multiplier);
                }
                return { totalSales, playerStats: { currentRank: state.ranks[currentRankIndex], exp, expToNextLevel } };
            };

            const renderDailyReport = () => {
                const calculated = recalculateState();
                const { salesGoal } = state.currentVoyage;
                // Only calculate achievement rate for the current voyage's sales
                const voyageSales = state.salesRecords
                    .filter(r => state.currentVoyage.startDate && state.currentVoyage.endDate && new Date(r.date) >= new Date(state.currentVoyage.startDate) && new Date(r.date) <= new Date(state.currentVoyage.endDate))
                    .reduce((sum, r) => sum + r.amount, 0);

                const achievementRate = salesGoal > 0 ? (voyageSales / salesGoal) * 100 : 0;
                const displayRate = Math.min(achievementRate, 100);
                
                DOMElements.salesGoal.textContent = `Â¥${(salesGoal || 0).toLocaleString()}`;
                DOMElements.currentSales.textContent = `Â¥${voyageSales.toLocaleString()}`; // Show voyage sales
                DOMElements.achievementRate.textContent = `${achievementRate.toFixed(1)}%`;
                DOMElements.progressBar.style.width = `${displayRate}%`;
                const shipPosition = 2 + (displayRate * 0.88);
                DOMElements.ship.style.left = `${shipPosition}%`;
                DOMElements.weatherIcon.style.left = `${shipPosition}%`;
                DOMElements.ship.textContent = achievementRate >= 100 ? 'ğŸ‰' : 'ğŸš¢';
                updateWeather(achievementRate);
                updatePlayerInfo(calculated);
                renderLogs();
                updateDailyChart();
            };
            
            const handleSetBudget = () => {
                const budget = parseInt(DOMElements.budgetInput.value, 10);
                const startDate = DOMElements.startDateInput.value;
                const endDate = DOMElements.endDateInput.value;
                
                if (isNaN(budget) || budget < 0 || !startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                     alert('å…¥åŠ›å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚æœŸé–“ã¨äºˆç®—ã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„ã€‚'); 
                     return;
                }

                const newVoyage = { startDate, endDate, salesGoal: budget };
                state.currentVoyage = newVoyage;
                
                // å±¥æ­´ã«åŒã˜æœŸé–“ã®è¨ˆç”»ãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
                const historyIndex = state.voyageHistory.findIndex(v => v.startDate === startDate && v.endDate === endDate);
                if (historyIndex > -1) {
                    state.voyageHistory[historyIndex] = newVoyage;
                } else {
                    state.voyageHistory.push(newVoyage);
                }
                
                saveState();
                renderDailyReport();
            };

            const handleSaleLog = () => {
                const amount = parseInt(DOMElements.salesInput.value, 10);
                const date = DOMElements.dateInput.value;
                if (isNaN(amount) || amount <= 0 || !date) { alert('æ—¥ä»˜ã¨å£²ä¸Šã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                
                const newRecord = { id: crypto.randomUUID(), amount, date, timestamp: new Date().getTime() };
                state.salesRecords.push(newRecord);
                
                saveState();
                renderDailyReport();
                DOMElements.salesInput.value = '';
            };

            const handleDeleteRecord = (id) => {
                state.salesRecords = state.salesRecords.filter(record => record.id !== id);
                saveState();
                renderDailyReport();
            };

            // --- Initial Setup ---
            const initializeGame = () => {
                const formatDate = (date) => {
                    const y = date.getFullYear();
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    const d = String(date.getDate()).padStart(2, '0');
                    return `${y}-${m}-${d}`;
                };
                
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                const hasLoaded = loadState();
                let setInputsToCurrentMonth = true; 

                if (hasLoaded && state.currentVoyage && state.currentVoyage.endDate) {
                    const endDate = new Date(state.currentVoyage.endDate);
                    endDate.setHours(0,0,0,0);
                    if (endDate >= today) {
                        setInputsToCurrentMonth = false;
                    }
                }

                if (setInputsToCurrentMonth) {
                    DOMElements.startDateInput.value = formatDate(firstDayOfMonth);
                    DOMElements.endDateInput.value = formatDate(lastDayOfMonth);
                    DOMElements.budgetInput.value = '';
                    // æ–°ã—ã„æœˆã«ç§»ã‚‹ã®ã§ã€currentVoyageã‚’ãƒªã‚»ãƒƒãƒˆ
                    state.currentVoyage = {
                        salesGoal: 0,
                        startDate: formatDate(firstDayOfMonth),
                        endDate: formatDate(lastDayOfMonth),
                    };
                } else {
                    DOMElements.startDateInput.value = state.currentVoyage.startDate || '';
                    DOMElements.endDateInput.value = state.currentVoyage.endDate || '';
                    DOMElements.budgetInput.value = state.currentVoyage.salesGoal > 0 ? state.currentVoyage.salesGoal : '';
                }

                DOMElements.dateInput.value = formatDate(new Date());
                DOMElements.logSalesBtn.addEventListener('click', handleSaleLog);
                DOMElements.setBudgetBtn.addEventListener('click', handleSetBudget);
                DOMElements.dailyTabBtn.addEventListener('click', () => switchTab('daily'));
                DOMElements.monthlyTabBtn.addEventListener('click', () => switchTab('monthly'));

                DOMElements.setThisMonthBtn.addEventListener('click', () => {
                    const today = new Date();
                    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    DOMElements.startDateInput.value = formatDate(firstDay);
                    DOMElements.endDateInput.value = formatDate(lastDay);
                });

                DOMElements.setTodayBtn.addEventListener('click', () => {
                    DOMElements.dateInput.value = formatDate(new Date());
                });
                
                renderDailyReport();
            };

            initializeGame();
        });
    </script>
</body>
</html>

