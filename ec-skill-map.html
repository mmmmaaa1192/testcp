<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC担当者スキルマップ & 売上構造可視化</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: #f8fafc;
        }
        .node circle {
            fill: #fff;
            stroke: #3b82f6;
            stroke-width: 3px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .node circle:hover {
            fill: #eff6ff;
            stroke: #2563eb;
            r: 12;
        }
        .node text {
            font-size: 14px;
            font-weight: 500;
            fill: #334155;
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
            cursor: pointer;
        }
        .link {
            fill: none;
            stroke: #cbd5e1;
            stroke-width: 2px;
            transition: all 0.5s ease;
        }
        .skill-tag {
            transition: all 0.2s;
        }
        .skill-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #tree-container {
            overflow: auto;
            cursor: grab;
        }
        #tree-container:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 p-4 border-b border-gray-200 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fas fa-sitemap"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">EC売上構造 × スキルマップ</h1>
        </div>
        <div class="text-sm text-gray-500">
            要素をクリックして関連スキルを確認
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Panel: Tree Visualization -->
        <div class="w-2/3 h-full relative bg-slate-50" id="tree-container">
            <!-- D3 Tree will be rendered here -->
            <div class="absolute top-4 left-4 bg-white/80 backdrop-blur p-2 rounded shadow text-xs text-gray-500">
                <i class="fas fa-mouse-pointer"></i> ノードをクリックで詳細表示<br>
                <i class="fas fa-arrows-alt"></i> ドラッグで移動 / ホイールでズーム
            </div>
        </div>

        <!-- Right Panel: Details & Skills -->
        <div class="w-1/3 bg-white shadow-xl border-l border-gray-200 overflow-y-auto p-6 z-20 flex flex-col">
            
            <!-- Default State -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fas fa-project-diagram text-6xl mb-4 text-gray-200"></i>
                <p class="text-lg">左のツリーから要素を選択してください</p>
            </div>

            <!-- Content State -->
            <div id="detail-content" class="hidden">
                <div class="mb-6">
                    <span class="text-xs font-bold text-blue-600 uppercase tracking-wider bg-blue-50 px-2 py-1 rounded">KPI Node</span>
                    <h2 id="node-title" class="text-3xl font-bold text-gray-800 mt-2 mb-2"></h2>
                    <p id="node-desc" class="text-gray-600 leading-relaxed"></p>
                </div>

                <div class="border-t border-gray-100 py-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-tools text-amber-500"></i> 必要なスキル・知識
                    </h3>
                    <div id="skills-list" class="flex flex-wrap gap-2">
                        <!-- Skills will be injected here -->
                    </div>
                </div>

                <div class="border-t border-gray-100 py-6 mt-auto">
                    <h3 class="text-md font-semibold text-gray-700 mb-3">アクションプラン例</h3>
                    <ul id="action-list" class="space-y-3">
                        <!-- Actions will be injected here -->
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Data Structure definition
        const treeData = {
            name: "EC売上 (KGI)",
            description: "ECサイトの最終目標である売上総額。全てのKPIはこの数値を最大化するために存在します。",
            children: [
                {
                    name: "アクセス数 (Traffic)",
                    description: "サイトへの訪問者数。新規顧客とリピーターに分類されます。",
                    skills: [
                        { name: "SEO対策", level: "high" },
                        { name: "Web広告運用", level: "high" },
                        { name: "SNS運用", level: "medium" },
                        { name: "コンテンツマーケティング", level: "medium" }
                    ],
                    actions: ["キーワード選定の見直し", "SNS投稿キャンペーン", "広告予算の最適化"],
                    children: [
                        {
                            name: "新規流入",
                            description: "初めてサイトを訪れるユーザー。",
                            skills: [
                                { name: "リスティング広告", level: "high" },
                                { name: "ディスプレイ広告", level: "medium" },
                                { name: "インフルエンサー施策", level: "medium" },
                                { name: "記事LP制作", level: "high" }
                            ],
                            actions: ["ターゲット層への広告配信拡大", "インフルエンサーとのコラボ"]
                        },
                        {
                            name: "リピート流入",
                            description: "過去に訪問したことがあるユーザー。",
                            skills: [
                                { name: "メルマガライティング", level: "high" },
                                { name: "LINE公式アカウント運用", level: "high" },
                                { name: "CRM分析", level: "high" },
                                { name: "リターゲティング広告", level: "medium" }
                            ],
                            actions: ["ステップメールの構築", "LINE限定クーポンの配布"]
                        }
                    ]
                },
                {
                    name: "転換率 (CVR)",
                    description: "訪問者が購入に至る確率。",
                    skills: [
                        { name: "UI/UXデザイン", level: "high" },
                        { name: "LPO (LP最適化)", level: "high" },
                        { name: "Web接客ツール", level: "medium" },
                        { name: "コピーライティング", level: "medium" }
                    ],
                    actions: ["フォームの入力項目削減", "商品画像の高画質化", "CTAボタンの改善"],
                    children: [
                        {
                            name: "直帰率改善",
                            description: "1ページだけ見て離脱するユーザーを減らす。",
                            skills: [
                                { name: "サイト高速化", level: "high" },
                                { name: "ファーストビュー改善", level: "high" },
                                { name: "ヒートマップ分析", level: "medium" }
                            ],
                            actions: ["画像の軽量化", "FVでの訴求文言テスト"]
                        },
                        {
                            name: "カゴ落ち対策",
                            description: "カートに入れたが購入完了しないユーザーを減らす。",
                            skills: [
                                { name: "EFO (入力フォーム最適化)", level: "high" },
                                { name: "決済手段導入", level: "medium" },
                                { name: "カゴ落ちメール", level: "medium" }
                            ],
                            actions: ["ゲスト購入機能の追加", "Amazon Pay等のID決済導入"]
                        }
                    ]
                },
                {
                    name: "客単価 (AOV)",
                    description: "顧客1人あたりの平均購入金額。",
                    skills: [
                        { name: "マーチャンダイジング (MD)", level: "high" },
                        { name: "キャンペーン企画", level: "medium" },
                        { name: "ロイヤリティプログラム", level: "high" }
                    ],
                    actions: ["まとめ買い割引", "送料無料ラインの調整"],
                    children: [
                        {
                            name: "商品単価",
                            description: "販売する商品の価格帯。",
                            skills: [
                                { name: "商品企画・開発", level: "high" },
                                { name: "ブランディング", level: "high" },
                                { name: "価格戦略", level: "medium" }
                            ],
                            actions: ["高付加価値商品の開発", "松竹梅の価格設定"]
                        },
                        {
                            name: "買上点数",
                            description: "1回の注文で購入される商品数。",
                            skills: [
                                { name: "クロスセル・アップセル", level: "high" },
                                { name: "レコメンドエンジン活用", level: "medium" },
                                { name: "セット商品企画", level: "medium" }
                            ],
                            actions: ["「これを見ている人はこれも」の表示", "セット販売ページの作成"]
                        }
                    ]
                }
            ]
        };

        // --- D3.js Implementation ---

        // Set dimensions
        const container = document.getElementById('tree-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        // Create SVG
        const svg = d3.select("#tree-container").append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .call(d3.zoom().on("zoom", (event) => {
                g.attr("transform", event.transform);
            }))
            .append("g")
            .attr("transform", "translate(100,0)"); // Initial offset

        const g = svg.append("g")
            .attr("transform", `translate(80, ${height / 2})`);

        // Tree layout
        const tree = d3.tree().size([height - 100, width - 300]);

        // Process data
        const root = d3.hierarchy(treeData);
        
        // Collapse function (initially expand all or collapse some)
        // root.children.forEach(collapse); 
        
        update(root);

        function update(source) {
            const treeData = tree(root);

            // Nodes
            const nodes = treeData.descendants();
            const links = treeData.links();

            // Normalize for fixed-depth
            nodes.forEach(d => { d.y = d.depth * 250; }); // Horizontal spacing

            // --- Nodes ---
            const node = g.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));

            const nodeEnter = node.enter().append('g')
                .attr('class', 'node')
                .attr("transform", d => `translate(${source.y0 || source.y},${source.x0 || source.x})`)
                .on('click', click);

            // Node circles
            nodeEnter.append('circle')
                .attr('class', 'node')
                .attr('r', 1e-6)
                .style("fill", d => d._children ? "#eff6ff" : "#fff");

            // Node labels
            nodeEnter.append('text')
                .attr("dy", ".35em")
                .attr("x", d => d.children || d._children ? -13 : 13)
                .attr("text-anchor", d => d.children || d._children ? "end" : "start")
                .text(d => d.data.name)
                .call(wrap, 200); // Optional text wrapping if needed

            // UPDATE
            const nodeUpdate = node.merge(nodeEnter).transition().duration(500)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            nodeUpdate.select('circle')
                .attr('r', 10)
                .style("fill", d => d._children ? "#eff6ff" : "#fff")
                .attr('cursor', 'pointer');

            // EXIT
            const nodeExit = node.exit().transition().duration(500)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .remove();

            nodeExit.select('circle').attr('r', 1e-6);
            nodeExit.select('text').style('fill-opacity', 1e-6);

            // --- Links ---
            const link = g.selectAll('path.link')
                .data(links, d => d.target.id);

            // Enter any new links at the parent's previous position.
            const linkEnter = link.enter().insert('path', "g")
                .attr("class", "link")
                .attr('d', d => {
                    const o = {x: source.x0 || source.x, y: source.y0 || source.y};
                    return diagonal(o, o);
                });

            // UPDATE
            const linkUpdate = link.merge(linkEnter).transition().duration(500)
                .attr('d', d => diagonal(d.source, d.target));

            // EXIT
            link.exit().transition().duration(500)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();

            // Store the old positions for transition.
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        let i = 0;

        // Curve function for links
        function diagonal(s, d) {
            return `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`;
        }

        // Toggle children on click
        function click(event, d) {
            // Show details
            showDetails(d.data);

            // Toggle children if present (collapsible)
            // if (d.children) {
            //     d._children = d.children;
            //     d.children = null;
            // } else {
            //     d.children = d._children;
            //     d._children = null;
            // }
            // update(d);
            
            // Highlight selected node
            d3.selectAll('circle').style("stroke", "#3b82f6").style("fill", "#fff");
            d3.select(this).select('circle').style("stroke", "#f59e0b").style("fill", "#fffbeb");
        }

        // --- Detail Panel Logic ---
        function showDetails(data) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('detail-content').classList.remove('hidden');

            // Text
            document.getElementById('node-title').textContent = data.name;
            document.getElementById('node-desc').textContent = data.description || "詳細情報はありません。";

            // Skills
            const skillsContainer = document.getElementById('skills-list');
            skillsContainer.innerHTML = '';
            
            if (data.skills && data.skills.length > 0) {
                data.skills.forEach(skill => {
                    const skillName = typeof skill === 'string' ? skill : skill.name;
                    // const skillLevel = typeof skill === 'string' ? 'normal' : skill.level;
                    
                    const el = document.createElement('div');
                    el.className = `skill-tag px-3 py-1 bg-white border border-slate-200 rounded-full text-sm font-medium text-slate-700 shadow-sm flex items-center gap-2`;
                    el.innerHTML = `<i class="fas fa-check-circle text-green-500 text-xs"></i> ${skillName}`;
                    skillsContainer.appendChild(el);
                });
            } else {
                skillsContainer.innerHTML = '<p class="text-gray-400 text-sm italic">特に関連するスキルセットは定義されていません。</p>';
            }

            // Actions
            const actionsContainer = document.getElementById('action-list');
            actionsContainer.innerHTML = '';
            if (data.actions && data.actions.length > 0) {
                data.actions.forEach(action => {
                    const li = document.createElement('li');
                    li.className = "flex items-start gap-3 text-sm text-gray-700 bg-gray-50 p-2 rounded";
                    li.innerHTML = `<i class="fas fa-angle-right mt-1 text-blue-400"></i> <span>${action}</span>`;
                    actionsContainer.appendChild(li);
                });
            } else {
                 actionsContainer.innerHTML = '<li class="text-gray-400 text-sm italic">アクションプランは未定義です。</li>';
            }
        }

        // Utility: Wrap text (simplified)
        function wrap(text, width) {
            text.each(function() {
                // Implementation omitted for brevity in this specific layout style
                // as we are positioning text to the side.
            });
        }
        
        // Initial render trigger
        // Simulate click on root to show initial data
        showDetails(treeData);

    </script>
</body>
</html>
